"""
ASSIGNMENT 2
GROUP NAME: DAN/EXT 22
GROUP MEMBER:
Nguyen Duy Quang Lai        -   s389980
Angel Chang                 -   s377501
Nicole Suzanne Sattler      -   s195029
Youssef Elkassaby           -   s392402
============================================================================
Question 2
Create a program that analyses temperature data collected from multiple weather 
stations in Australia. The data is stored in multiple CSV files under a "temperatures" 
folder, with each file representing data from one year. Process ALL .csv files in the 
temperatures folder. Ignore missing temperature values (NaN) in calculations.
"""

import csv
import glob
import os
import statistics

def analyze_weather_data():
    # Display a message to indicate the program has started
    print("--- Starting Weather Data Analysis ---")
    
    # Define the folder that contains the CSV files
    folder_path = "temperatures"
    
    # Create a file pattern to match all required CSV files
    file_pattern = os.path.join(folder_path, "stations_group_*.csv")
    
    # Get a list of all matching CSV files
    csv_files = glob.glob(file_pattern)
    
    # If no CSV files are found, stop the program
    if not csv_files:
        print("Error: No CSV files found in the temperatures folder.")
        return
    # Define Australian seasons and their corresponding months
    seasons_map = {
        'Summer': ['December', 'January', 'February'],
        'Autumn': ['March', 'April', 'May'],
        'Winter': ['June', 'July', 'August'],
        'Spring': ['September', 'October', 'November']
    }

    # Dictionary to store temperatures for each season
    season_temps = {season: [] for season in seasons_map}
    
    # Dictionary to store all temperatures for each station
    station_data = {}

    print(f"Processing {len(csv_files)} files...")

    # Loop through each CSV file
    for filename in csv_files:
        # Open the CSV file
        with open(filename, 'r', encoding='utf-8-sig') as f:
            reader = csv.DictReader(f)
            
            # Remove extra spaces from column headers
            reader.fieldnames = [name.strip() for name in reader.fieldnames]

            # Read each row of the CSV file
            for row in reader:
                # Get the station name
                station_name = row.get('STATION_NAME')
                
                # Skip rows without a station name
                if not station_name:
                    continue

                # Create a new list for the station if it doesn't exist
                if station_name not in station_data:
                    station_data[station_name] = []

                # Loop through each season and its months
                for season, months in seasons_map.items():
                    for month in months:
                        temp_str = row.get(month)

                        # Ignore missing or invalid temperature values
                        if temp_str and temp_str.strip().lower() not in ['nan', '', 'null']:
                            temp = float(temp_str)

                            # Add temperature to seasonal data
                            season_temps[season].append(temp)
                            
                            # Add temperature to station-specific data
                            station_data[station_name].append(temp)

    # TASK 1: SEASONAL AVERAGES
    
    with open("average_temp.txt", "w") as f:
        for season in ['Summer', 'Autumn', 'Winter', 'Spring']:
            temps = season_temps[season]
            if temps:
                average = sum(temps) / len(temps)
                f.write(f"{season}: {average:.1f}°C\n")

    print("Generated: average_temp.txt")

    
    # PREPARE STATION STATISTICS
    
    station_stats = []

    # Calculate statistics for each station
    for station, temps in station_data.items():
        if temps:
            maximum = max(temps)
            minimum = min(temps)
            temp_range = maximum - minimum
            std_dev = statistics.stdev(temps) if len(temps) > 1 else 0.0

            station_stats.append({
                'name': station,
                'range': temp_range,
                'max': maximum,
                'min': minimum,
                'std': std_dev
            })

    
    # TASK 2: LARGEST TEMPERATURE RANGE
    
    max_range = max(s['range'] for s in station_stats)

    with open("largest_temp_range_station.txt", "w") as f:
        for s in station_stats:
            if s['range'] == max_range:
                f.write(
                    f"Station {s['name']}: "
                    f"Range {s['range']:.1f}°C "
                    f"(Max: {s['max']:.1f}°C, Min: {s['min']:.1f}°C)\n"
                )

    print("Generated: largest_temp_range_station.txt")

    
    # TASK 3: TEMPERATURE STABILITY
    
    min_std = min(s['std'] for s in station_stats)
    max_std = max(s['std'] for s in station_stats)

    with open("temperature_stability_stations.txt", "w") as f:
        for s in station_stats:
            if s['std'] == min_std:
                f.write(f"Most Stable: Station {s['name']}: StdDev {s['std']:.1f}°C\n")
        for s in station_stats:
            if s['std'] == max_std:
                f.write(f"Most Variable: Station {s['name']}: StdDev {s['std']:.1f}°C\n")

    print("Generated: temperature_stability_stations.txt")
    print("--- Analysis Complete ---")

# Run the program
if __name__ == "__main__":
    analyze_weather_data()

